

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Custom input transformation &mdash; IPython 7.9.0.dev documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="IPython Events" href="callbacks.html" />
    <link rel="prev" title="Defining custom magics" href="custommagics.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> IPython
          

          
          </a>

          
            
            
              <div class="version">
                7.9.0.dev
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">IPython Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../whatsnew/index.html">What’s new in IPython</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../interactive/index.html">Tutorial</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Configuration and customization</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#configuring-ipython">Configuring IPython</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#extending-and-integrating-with-ipython">Extending and integrating with IPython</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="extensions/index.html">IPython extensions</a></li>
<li class="toctree-l3"><a class="reference internal" href="integrating.html">Integrating your objects with IPython</a></li>
<li class="toctree-l3"><a class="reference internal" href="custommagics.html">Defining custom magics</a></li>
<li class="toctree-l3"><a class="reference internal" href="custommagics.html#accessing-user-namespace-and-local-scope">Accessing user namespace and local scope</a></li>
<li class="toctree-l3"><a class="reference internal" href="custommagics.html#complete-example">Complete Example</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Custom input transformation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#string-based-transformations">String based transformations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ast-transformations">AST transformations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="callbacks.html">IPython Events</a></li>
<li class="toctree-l3"><a class="reference internal" href="eventloops.html">Integrating with GUI event loops</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development/index.html">Developer’s guide for third party tools and libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coredev/index.html">Guide for IPython core Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">The IPython API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sphinxext.html">IPython Sphinx Directive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about/index.html">About IPython</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">IPython</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Configuration and customization</a> &raquo;</li>
        
      <li>Custom input transformation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/config/inputtransforms.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This documentation covers a development version of IPython. The development
version may differ significantly from the latest stable release.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>This documentation covers IPython versions 6.0 and higher. Beginning with
version 6.0, IPython stopped supporting compatibility with Python versions
lower than 3.3 including all versions of Python 2.7.</p>
<p>If you are looking for an IPython version compatible with Python 2.7,
please use the IPython 5.x LTS release and refer to its documentation (LTS
is the long term support release).</p>
</div>
<div class="section" id="custom-input-transformation">
<h1>Custom input transformation<a class="headerlink" href="#custom-input-transformation" title="Permalink to this headline">¶</a></h1>
<p>IPython extends Python syntax to allow things like magic commands, and help with
the <code class="docutils literal notranslate"><span class="pre">?</span></code> syntax. There are several ways to customise how the user’s input is
processed into Python code to be executed.</p>
<p>These hooks are mainly for other projects using IPython as the core of their
interactive interface. Using them carelessly can easily break IPython!</p>
<div class="section" id="string-based-transformations">
<h2>String based transformations<a class="headerlink" href="#string-based-transformations" title="Permalink to this headline">¶</a></h2>
<p>When the user enters code, it is first processed as a string. By the
end of this stage, it must be valid Python syntax.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 7.0: </span>The API for string and token-based transformations has been completely
redesigned. Any third party code extending input transformation will need to
be rewritten. The new API is, hopefully, simpler.</p>
</div>
<p>String based transformations are functions which accept a list of strings:
each string is a single line of the input cell, including its line ending.
The transformation function should return output in the same structure.</p>
<p>These transformations are in two groups, accessible as attributes of
the <a class="reference internal" href="../api/generated/IPython.core.interactiveshell.html#IPython.core.interactiveshell.InteractiveShell" title="IPython.core.interactiveshell.InteractiveShell"><code class="xref py py-class docutils literal notranslate"><span class="pre">InteractiveShell</span></code></a> instance.
Each group is a list of transformation functions.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">input_transformers_cleanup</span></code> run first on input, to do things like stripping
prompts and leading indents from copied code. It may not be possible at this
stage to parse the input as valid Python code.</p></li>
<li><p>Then IPython runs its own transformations to handle its special syntax, like
<code class="docutils literal notranslate"><span class="pre">%magics</span></code> and <code class="docutils literal notranslate"><span class="pre">!system</span></code> commands. This part does not expose extension
points.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">input_transformers_post</span></code> run as the last step, to do things like converting
float literals into decimal objects. These may attempt to parse the input as
Python code.</p></li>
</ul>
<p>These transformers may raise <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#SyntaxError" title="(in Python v3.7)"><code class="xref py py-exc docutils literal notranslate"><span class="pre">SyntaxError</span></code></a> if the input code is invalid, but
in most cases it is clearer to pass unrecognised code through unmodified and let
Python’s own parser decide whether it is valid.</p>
<p>For example, imagine we want to obfuscate our code by reversing each line, so
we’d write <code class="docutils literal notranslate"><span class="pre">)5(f</span> <span class="pre">=+</span> <span class="pre">a</span></code> instead of <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">+=</span> <span class="pre">f(5)</span></code>. Here’s how we could swap it
back the right way before IPython tries to run it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">reverse_line_chars</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
    <span class="n">new_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">chars</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># the newline needs to stay at the end</span>
        <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chars</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_lines</span>
</pre></div>
</div>
<p>To start using this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ip</span> <span class="o">=</span> <span class="n">get_ipython</span><span class="p">()</span>
<span class="n">ip</span><span class="o">.</span><span class="n">input_transformers_cleanup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reverse_line_chars</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="ast-transformations">
<h2>AST transformations<a class="headerlink" href="#ast-transformations" title="Permalink to this headline">¶</a></h2>
<p>After the code has been parsed as Python syntax, you can use Python’s powerful
<em>Abstract Syntax Tree</em> tools to modify it. Subclass <a class="reference external" href="https://docs.python.org/3/library/ast.html#ast.NodeTransformer" title="(in Python v3.7)"><code class="xref py py-class docutils literal notranslate"><span class="pre">ast.NodeTransformer</span></code></a>,
and add an instance to <code class="docutils literal notranslate"><span class="pre">shell.ast_transformers</span></code>.</p>
<p>This example wraps integer literals in an <code class="docutils literal notranslate"><span class="pre">Integer</span></code> class, which is useful for
mathematical frameworks that want to handle e.g. <code class="docutils literal notranslate"><span class="pre">1/3</span></code> as a precise fraction:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">IntegerWrapper</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeTransformer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wraps all integers in a call to Integer()&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">visit_Num</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;Integer&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span>
                            <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">node</span><span class="p">],</span> <span class="n">keywords</span><span class="o">=</span><span class="p">[])</span>
        <span class="k">return</span> <span class="n">node</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="callbacks.html" class="btn btn-neutral float-right" title="IPython Events" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="custommagics.html" class="btn btn-neutral float-left" title="Defining custom magics" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The IPython Development Team
      <span class="lastupdated">
        Last updated on Aug 30, 2019.
      </span>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>